#!/usr/bin/env python3
# This is the test driver for the parser tests.
import os, sys
import shutil
from pprint import pprint as prt

num_run = 0
num_pass = 0
num_skip = 0
num_error = 0
num_fail = 0

def read_line(fp) :
    '''
    Read a line from the test list and skip comments and blank lines. This
    returns None when the file is ended.
    '''
    for line in fp :
        lst = line.split("#")
        line = lst[0].strip()
        if len(line) > 0 :
            yield line

def read_test_list(dir_name) :
    '''
    This creates the master test dictionary. It is created from reading the
    test_list.txt files that appear in the directories associated with the
    different parser productions. Returns a list of the lines that were
    processed.
    '''
    fname = os.path.join(dir_name, "test_list.txt")
    lst = []
    with open(fname, "r") as fp :
        for line in read_line(fp) :
            x = line.split(":")
            lst.append({'name':x[0], 'status':x[1]})

    return lst

def read_master_list() :
    '''
    Read all of the tests in from the test_list.txt files.
    '''
    lst = {}
    dir = os.getcwd()
    lst = read_test_list(dir)

    for x in lst :
        # path with the group name
        d = os.path.join(dir, x['name'])
        x['class'] = read_test_list(d)
        
        for y in x['class'] :
            p = os.path.join(d, y['name'])
            y['dir'] = p
            y['type'] = read_test_list(p)

            for n in y['type'] :
                g = os.path.join(p, n['name'])
                n['tests'] = read_test_list(g)

    #prt(lst)
    return lst

def run_test(name) :
    '''
    Run the specified test
    '''
    global num_pass, num_fail 

    d = name+".simp"
    if os.path.isfile(d) :
        sys.stdout.write("PASS\n")
        num_pass += 1
    else :
        sys.stdout.write("FAIL\n")
        num_fail += 1

def skip_test(tst) :
    sys.stdout.write("            TEST: '%s' (SKIP)\n"%(lst['name']))

def skip_type(lst) :
    sys.stdout.write("        TYPE: '%s' (SKIP)\n"%(lst['name']))
    for item in lst :
        skip_test(item)

def skip_class(lst) :
    sys.stdout.write("    CLASS: '%s' (SKIP)\n"%(lst['name']))
    for item in lst :
        skip_type(item)

def skip_group(lst) :
    sys.stdout.write("\nGROUP: '%s' (SKIP)\n"%(lst['name']))
    for item in lst :
        skip_class(item)

def run_type(lst) :
    prt(lst)
    for item in lst :
        if item['status'] == 'run' :
            run_test(item['tests'])
        else :
            skip_test(item['tests'])

def run_class(lst) :
    for item in lst :
        if item['status'] == 'run' :
            run_type(item['type'])
        else :
            skip_type(item['type'])
      
def runner(master) :
    '''
    Run all tests that are marked with 'run'. The run flag is used to switch 
    whether a test is attempted or skipped. If the group is marked as skip, 
    all of the classes and lower branches are also disabled. This is so that 
    the test is counted whether it is run or skipped.
    '''
    for item in master :
        sys.stdout.write("\nGROUP: '%s'\n"%(item['name']))
        if item['status'] == 'run' :
            run_class(item['class'])
        else :
            skip_class(item['class'])


    # global num_run, num_skip
    # run_flag = True

    # for group in master :
    #     run_flag = True
    #     sys.stdout.write("\nGROUP: '%s'\n"%(group['name']))
    #     if group['status'].lower() != 'run' :
    #         run_flag = False

    #     for cls in group['class'] :
    #         sys.stdout.write("    CLASS: '%s'\n"%(cls['name']))
    #         if cls['status'] != 'run' :
    #             run_flag = False
    #         dir = cls['dir']

    #         for type in cls['type'] :
    #             sys.stdout.write("        TYPE: '%s'\n"%(type['name']))
    #             if type['status'] != 'run' :
    #                 run_flag = False

    #             x = os.path.join(dir, type['name'])
    #             for tst in type['tests'] :
    #                 if tst['status'] == 'run' and run_flag is True :
    #                     sys.stdout.write("            TEST: '%s' RUN - "%(tst['name']))
    #                     num_run += 1
    #                     run_test(os.path.join(x, 'tests', tst['name']))
    #                 else :
    #                     sys.stdout.write("            TEST: '%s' SKIP\n"%(tst['name']))
    #                     num_skip += 1

if __name__ == "__main__" :
    
    lst = read_master_list()
    runner(lst)
    print("run:", num_run, 
          "pass:", num_pass, 
          "fail:", num_fail, 
          "skip:", num_skip)

    #prt(lst)